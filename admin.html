<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>私密留言板 - 管理终端</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-sidebar">
            <div class="admin-header">
                <h2>🛠️ 管理终端</h2>
                <button id="logout-admin" class="logout-btn">退出</button>
            </div>
            
            <div class="key-management">
                <h3>密钥管理</h3>
                <div class="create-key-form">
                    <input type="text" id="new-key-name" placeholder="密钥名称（如：学生A）">
                    <input type="text" id="new-key-value" placeholder="密钥内容（如：星光对话2024）">
                    <button id="create-key-btn" class="primary-btn">创建新密钥</button>
                </div>
            </div>

            <div class="key-list-container">
                <h4>现有密钥列表</h4>
                <div id="key-list" class="key-list">
                    <!-- 密钥列表动态加载 -->
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>

        <div class="admin-main">
            <div id="chat-selection" class="chat-selection">
                <div class="welcome-message">
                    <h1>欢迎使用管理终端</h1>
                    <p>请在左侧选择或创建一个密钥开始对话</p>
                </div>
            </div>
            
            <div id="chat-interface" class="chat-interface" style="display: none;">
                <!-- 对话界面由 chat.html 加载 -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // 管理员专用JavaScript
        let currentToken = '';
        
        document.getElementById('create-key-btn').addEventListener('click', createNewKey);
        document.getElementById('logout-admin').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'index.html';
        });

        // 初始化管理员界面
        document.addEventListener('DOMContentLoaded', async function() {
            await loadExistingKeys();
        });

        async function createNewKey() {
            const keyName = document.getElementById('new-key-name').value.trim();
            const keyValue = document.getElementById('new-key-value').value.trim();
            
            if (!keyName || !keyValue) {
                showAlert('请填写密钥名称和内容', 'error');
                return;
            }

            if (!currentToken) {
                currentToken = prompt('请输入GitHub Personal Access Token：');
                if (!currentToken) return;
            }

            try {
                showAlert('创建密钥中...', 'info');
                
                // 创建新的Issue作为对话线程
                const issue = await createNewIssue(keyName, keyValue, currentToken);
                
                if (issue) {
                    showAlert(`密钥 "${keyValue}" 创建成功！`, 'success');
                    document.getElementById('new-key-name').value = '';
                    document.getElementById('new-key-value').value = '';
                    await loadExistingKeys();
                }
            } catch (error) {
                console.error('创建密钥错误:', error);
                showAlert('创建失败: ' + error.message, 'error');
            }
        }

        async function loadExistingKeys() {
            try {
                const issues = await getAllIssues();
                const keyList = document.getElementById('key-list');
                
                if (issues.length === 0) {
                    keyList.innerHTML = '<div class="no-keys">暂无密钥，请创建第一个密钥</div>';
                    return;
                }

                keyList.innerHTML = issues.map(issue => {
                    const secretKey = extractSecretKeyFromIssue(issue);
                    return `
                        <div class="key-item" data-issue-number="${issue.number}">
                            <div class="key-name">${issue.title.replace('密钥: ', '')}</div>
                            <div class="key-value">${secretKey}</div>
                            <button class="chat-btn" onclick="openChat(${issue.number}, '${secretKey}')">进入对话</button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载密钥列表错误:', error);
                document.getElementById('key-list').innerHTML = '<div class="error">加载失败</div>';
            }
        }

        function openChat(issueNumber, secretKey) {
            localStorage.setItem('currentChat', JSON.stringify({
                issueNumber: issueNumber,
                secretKey: secretKey,
                userType: 'admin'
            }));
            // 在管理界面内加载聊天
            loadChatInterface(issueNumber, secretKey, 'admin');
        }

        function loadChatInterface(issueNumber, secretKey, userType) {
            document.getElementById('chat-selection').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'block';
            document.getElementById('chat-interface').innerHTML = `
                <iframe src="chat.html" style="width: 100%; height: 100vh; border: none;"></iframe>
            `;
        }
    </script>
</body>
</html>
