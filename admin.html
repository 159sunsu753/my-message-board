<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§å¯†ç•™è¨€æ¿ - ç®¡ç†ç»ˆç«¯</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-sidebar">
            <div class="admin-header">
                <h2>ğŸ› ï¸ ç®¡ç†ç»ˆç«¯</h2>
                <button id="logout-admin" class="logout-btn">é€€å‡º</button>
            </div>
            
            <div class="key-management">
                <h3>å¯†é’¥ç®¡ç†</h3>
                <div class="create-key-form">
                    <input type="text" id="new-key-name" placeholder="å¯†é’¥åç§°ï¼ˆå¦‚ï¼šå­¦ç”ŸAï¼‰">
                    <input type="text" id="new-key-value" placeholder="å¯†é’¥å†…å®¹ï¼ˆå¦‚ï¼šæ˜Ÿå…‰å¯¹è¯2024ï¼‰">
                    <button id="create-key-btn" class="primary-btn">åˆ›å»ºæ–°å¯†é’¥</button>
                </div>
            </div>

            <div class="key-list-container">
                <h4>ç°æœ‰å¯†é’¥åˆ—è¡¨</h4>
                <div id="key-list" class="key-list">
                    <!-- å¯†é’¥åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <div class="admin-main">
            <div id="chat-selection" class="chat-selection">
                <div class="welcome-message">
                    <h1>æ¬¢è¿ä½¿ç”¨ç®¡ç†ç»ˆç«¯</h1>
                    <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªå¯†é’¥å¼€å§‹å¯¹è¯</p>
                </div>
            </div>
            
            <div id="chat-interface" class="chat-interface" style="display: none;">
                <!-- å¯¹è¯ç•Œé¢ç”± chat.html åŠ è½½ -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // ç®¡ç†å‘˜ä¸“ç”¨JavaScript
        let currentToken = '';
        
        document.getElementById('create-key-btn').addEventListener('click', createNewKey);
        document.getElementById('logout-admin').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'index.html';
        });

        // åˆå§‹åŒ–ç®¡ç†å‘˜ç•Œé¢
        document.addEventListener('DOMContentLoaded', async function() {
            await loadExistingKeys();
        });

        async function createNewKey() {
            const keyName = document.getElementById('new-key-name').value.trim();
            const keyValue = document.getElementById('new-key-value').value.trim();
            
            if (!keyName || !keyValue) {
                showAlert('è¯·å¡«å†™å¯†é’¥åç§°å’Œå†…å®¹', 'error');
                return;
            }

            if (!currentToken) {
                currentToken = prompt('è¯·è¾“å…¥GitHub Personal Access Tokenï¼š');
                if (!currentToken) return;
            }

            try {
                showAlert('åˆ›å»ºå¯†é’¥ä¸­...', 'info');
                
                // åˆ›å»ºæ–°çš„Issueä½œä¸ºå¯¹è¯çº¿ç¨‹
                const issue = await createNewIssue(keyName, keyValue, currentToken);
                
                if (issue) {
                    showAlert(`å¯†é’¥ "${keyValue}" åˆ›å»ºæˆåŠŸï¼`, 'success');
                    document.getElementById('new-key-name').value = '';
                    document.getElementById('new-key-value').value = '';
                    await loadExistingKeys();
                }
            } catch (error) {
                console.error('åˆ›å»ºå¯†é’¥é”™è¯¯:', error);
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadExistingKeys() {
            try {
                const issues = await getAllIssues();
                const keyList = document.getElementById('key-list');
                
                if (issues.length === 0) {
                    keyList.innerHTML = '<div class="no-keys">æš‚æ— å¯†é’¥ï¼Œè¯·åˆ›å»ºç¬¬ä¸€ä¸ªå¯†é’¥</div>';
                    return;
                }

                keyList.innerHTML = issues.map(issue => {
                    const secretKey = extractSecretKeyFromIssue(issue);
                    return `
                        <div class="key-item" data-issue-number="${issue.number}">
                            <div class="key-name">${issue.title.replace('å¯†é’¥: ', '')}</div>
                            <div class="key-value">${secretKey}</div>
                            <button class="chat-btn" onclick="openChat(${issue.number}, '${secretKey}')">è¿›å…¥å¯¹è¯</button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½å¯†é’¥åˆ—è¡¨é”™è¯¯:', error);
                document.getElementById('key-list').innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
            }
        }

        function openChat(issueNumber, secretKey) {
            localStorage.setItem('currentChat', JSON.stringify({
                issueNumber: issueNumber,
                secretKey: secretKey,
                userType: 'admin'
            }));
            // åœ¨ç®¡ç†ç•Œé¢å†…åŠ è½½èŠå¤©
            loadChatInterface(issueNumber, secretKey, 'admin');
        }

        function loadChatInterface(issueNumber, secretKey, userType) {
            document.getElementById('chat-selection').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'block';
            document.getElementById('chat-interface').innerHTML = `
                <iframe src="chat.html" style="width: 100%; height: 100vh; border: none;"></iframe>
            `;
        }
    </script>
</body>
</html>
